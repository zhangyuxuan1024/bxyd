package net.iclassmate.xydspace.ui.activitys.index;

import android.app.Activity;
import android.content.Intent;
import android.os.Bundle;
import android.view.View;
import android.widget.ImageView;
import android.widget.ListView;
import android.widget.TextView;

import net.iclassmate.xydspace.R;
import net.iclassmate.xydspace.adapter.SignAdapter;
import net.iclassmate.xydspace.bean.index.Banner;
import net.iclassmate.xydspace.bean.index.PersonInfo;
import net.iclassmate.xydspace.bean.index.Recommend;

import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.List;

public class SignUpActivity extends Activity implements View.OnClickListener {
    private Banner banner;
    private Recommend recommend;

    private TextView tv_pay, tv_back, tv_title, tv_time, tv_money, tv_sub, tv_add, tv_count, tv_count_money;
    private ImageView img_back;

    private int person_count;
    private double price;

    private SignAdapter adapter;
    private List<PersonInfo> list;
    private ListView listView;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_sign_up);
        init();
        initData();
    }

    private void init() {
        tv_pay = (TextView) findViewById(R.id.tv_pay);
        tv_pay.setOnClickListener(this);
        img_back = (ImageView) findViewById(R.id.study_message_back);
        img_back.setOnClickListener(this);
        tv_back = (TextView) findViewById(R.id.study_message_left_tv);
        tv_back.setOnClickListener(this);
        tv_back.setText("返回");
        tv_title = (TextView) findViewById(R.id.study_message_title_tv);
        tv_title.setText("报名");

        tv_time = (TextView) findViewById(R.id.sign_tv_time);
        tv_money = (TextView) findViewById(R.id.sign_tv_money);

        tv_sub = (TextView) findViewById(R.id.sign_tv_sub);
        tv_sub.setOnClickListener(this);
        tv_add = (TextView) findViewById(R.id.sign_tv_add);
        tv_add.setOnClickListener(this);
        tv_count = (TextView) findViewById(R.id.sign_tv_count);
        tv_count_money = (TextView) findViewById(R.id.sign_tv_count_money);

        listView = (ListView) findViewById(R.id.listView);
        list = new ArrayList<>();
        adapter = new SignAdapter(this, list);
        PersonInfo personInfo = new PersonInfo();
        personInfo.setMaleSelect(true);
        list.add(personInfo);
        listView.setAdapter(adapter);

        person_count = 1;

        setAdapter();
    }

    @Override
    public void onClick(View v) {
        switch (v.getId()) {
            case R.id.tv_pay:
                Intent intent = new Intent(this, PayMoneyActivity.class);
                startActivity(intent);
                break;
            case R.id.study_message_back:
            case R.id.study_message_left_tv:
                finish();
                break;
            case R.id.sign_tv_sub:
                if (person_count < 2) {
                    return;
                }
                person_count--;
                tv_count.setText(person_count + "");
                list.clear();
                for (int i = 0; i < person_count; i++) {
                    PersonInfo info = new PersonInfo();
                    info.setMaleSelect(true);
                    list.add(info);
                }
                adapter.notifyDataSetChanged();

                tv_count_money.setText("合计：￥" + String.format("%.2f", person_count * price));
                break;
            case R.id.sign_tv_add:
                person_count++;
                tv_count.setText(person_count + "");
                list.clear();
                for (int i = 0; i < person_count; i++) {
                    PersonInfo info = new PersonInfo();
                    info.setMaleSelect(true);
                    list.add(info);
                }
                adapter.notifyDataSetChanged();

                tv_count_money.setText("合计：￥" + String.format("%.2f", person_count * price));
                break;
        }
    }

    private void initData() {
        Intent intent = getIntent();
        Object object = intent.getSerializableExtra("data");
        if (object instanceof Banner) {
            banner = (Banner) object;
        } else if (object instanceof Recommend) {
            recommend = (Recommend) object;
        }

        if (banner != null) {
            long time = banner.getStart_time();
            SimpleDateFormat dateFormater = new SimpleDateFormat("yyyy年MM月dd日");
            String start_time = dateFormater.format(time);
            tv_time.setText(start_time);

            price = banner.getPrice();
            tv_money.setText("￥" + String.format("%.2f", price));
            tv_count_money.setText("合计：￥" + String.format("%.2f", price));
        } else if (recommend != null) {
            long time = recommend.getStart_time();
            SimpleDateFormat dateFormater = new SimpleDateFormat("yyyy年MM月dd日");
            String start_time = dateFormater.format(time);
            tv_time.setText(start_time);

            price = recommend.getPrice();
            tv_money.setText("￥" + String.format("%.2f", price));
            tv_count_money.setText("合计：￥" + String.format("%.2f", price));
        }
    }

    private void setAdapter() {
        adapter.setImgMaleClick(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                int postion = (int) v.getTag();
                PersonInfo info = list.get(postion);
                if (!info.isMaleSelect()) {
                    info.setMaleSelect(true);
                    adapter.notifyDataSetChanged();
                }
            }
        });

        adapter.setImgFemaleClick(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                int postion = (int) v.getTag();
                PersonInfo info = list.get(postion);
                if (info.isMaleSelect()) {
                    info.setMaleSelect(false);
                    adapter.notifyDataSetChanged();
                }
            }
        });
    }
}
