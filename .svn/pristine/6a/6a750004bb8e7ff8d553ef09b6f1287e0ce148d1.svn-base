package net.iclassmate.xydspace.adapter;

import android.content.Context;
import android.content.SharedPreferences;
import android.graphics.Bitmap;
import android.net.Uri;
import android.os.Handler;
import android.text.SpannableString;
import android.util.Log;
import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;
import android.widget.BaseAdapter;
import android.widget.FrameLayout;
import android.widget.ImageView;
import android.widget.LinearLayout;
import android.widget.TextView;

import com.squareup.picasso.Picasso;

import net.iclassmate.xydspace.R;
import net.iclassmate.xydspace.bean.message.ImageProgress;
import net.iclassmate.xydspace.bean.message.RMessage;
import net.iclassmate.xydspace.bean.message.SpaceMessage;
import net.iclassmate.xydspace.constant.Constant;
import net.iclassmate.xydspace.utils.BitmapUtils;
import net.iclassmate.xydspace.utils.FileUtils;
import net.iclassmate.xydspace.utils.HttpManager;
import net.iclassmate.xydspace.utils.emotion.SpanStringUtils;
import net.iclassmate.xydspace.view.study.ShapeImageView;

import org.json.JSONException;
import org.json.JSONObject;

import java.security.acl.LastOwnerException;
import java.util.List;

import io.rong.imlib.model.Message;
import io.rong.message.ImageMessage;
import io.rong.message.RecallNotificationMessage;
import io.rong.message.TextMessage;

/**
 * Created by xyd on 2016/5/31.
 */
public class MessagesAdapter extends BaseAdapter {
    private List<Message> messageList;
    private Context mContext;
    private boolean isShowName;
    //图片发送进度
    private List<ImageProgress> progressList;

    final static int VIEW_TYPE_FROM = 0;
    final static int VIEW_TYPE_TO = 1;
    private int emotion_map_type = 0x0001;
    public String friendName;
    private HttpManager httpManager;
    private Handler mHandler = new Handler();

    private View.OnClickListener onHeadClick;
    private View.OnClickListener onMesgClick;
    private View.OnLongClickListener onMesgLongClick;
    private View.OnClickListener onclickSendMessage;
    private View.OnClickListener onclickOpenFile;

    private SharedPreferences sharedPreferences;

    public void setOnHeadClick(View.OnClickListener onHeadClick) {
        this.onHeadClick = onHeadClick;
    }

    public void setOnMesgClick(View.OnClickListener onMesgClick) {
        this.onMesgClick = onMesgClick;
    }

    public void setOnMesgLongClick(View.OnLongClickListener onMesgLongClick) {
        this.onMesgLongClick = onMesgLongClick;
    }

    public List<ImageProgress> getProgressList() {
        return progressList;
    }

    public void setProgressList(List<ImageProgress> progressList) {
        this.progressList = progressList;
    }

    public void setOnclickSendMessage(View.OnClickListener onclickSendMessage) {
        this.onclickSendMessage = onclickSendMessage;
    }

    public void setOnclickOpenFile(View.OnClickListener onclickOpenFile) {
        this.onclickOpenFile = onclickOpenFile;
    }

    public MessagesAdapter(List<Message> messageList, Context context) {
        this.messageList = messageList;
        this.mContext = context;
        httpManager = new HttpManager();
        sharedPreferences = context.getSharedPreferences(Constant.SHARED_PREFERENCES, Context.MODE_PRIVATE);
    }

    public boolean isShowName() {
        return isShowName;
    }

    public void setIsShowName(boolean isShowName) {
        this.isShowName = isShowName;
    }

    @Override
    public int getCount() {
        int ret = 0;
        if (messageList != null) {
            ret = messageList.size();
        }
        return ret;
    }

    @Override
    public Object getItem(int position) {
        return messageList.get(position);
    }

    @Override
    public long getItemId(int position) {
        return position;
    }


    @Override
    public int getViewTypeCount() {
        return 9;
    }

    @Override
    public int getItemViewType(int position) {
        int ret = 0;
        Message message = messageList.get(position);
        if (message.getMessageDirection() == Message.MessageDirection.SEND) {
            if (message.getContent() instanceof TextMessage || message.getContent() instanceof SpaceMessage) {
                String info = null;
                if (message.getContent() instanceof TextMessage) {
                    TextMessage textMessage = (TextMessage) message.getContent();
                    info = textMessage.getContent();
                } else if (message.getContent() instanceof SpaceMessage) {
                    SpaceMessage spaceMessage = (SpaceMessage) message.getContent();
                    info = spaceMessage.getContent();
                }
                JSONObject json = null;
                try {
                    json = new JSONObject(info);
                } catch (JSONException e) {
                    e.printStackTrace();
                }
                String filename = json.optString("FileName");
                int contentType = json.optInt("ContentType");
                String fileId = json.optString("FileID");
                int messageType = json.optInt("MessageType");
                if (messageType == 0) {
                    if (filename != null && !filename.equals("")) {
                        contentType = FileUtils.getContentType(filename);
                    }
                    //文字，图片
                    if (contentType == 0 || contentType == 1 || contentType == 2) {
                        ret = 0;
                    } else if (contentType == 4) {
                        //视频
                        ret = 2;
                    } else if (contentType == 8 || contentType == 9) {
                        //发动态
                        ret = 7;
                    } else {
                        //文件
                        ret = 1;
                    }
                } else if (messageType == 10) {
                    ret = 6;
                }
            } else if (message.getContent() instanceof ImageMessage) {
                ret = 0;
            }
        } else if (message.getMessageDirection() == Message.MessageDirection.RECEIVE) {
            if (message.getContent() instanceof TextMessage || message.getContent() instanceof SpaceMessage) {
                String info = null;
                if (message.getContent() instanceof TextMessage) {
                    TextMessage textMessage = (TextMessage) message.getContent();
                    info = textMessage.getContent();
                } else if (message.getContent() instanceof SpaceMessage) {
                    SpaceMessage spaceMessage = (SpaceMessage) message.getContent();
                    info = spaceMessage.getContent();
                }
                JSONObject json = null;
                try {
                    json = new JSONObject(info);
                } catch (JSONException e) {
                    e.printStackTrace();
                }
                String filename = json.optString("FileName");
                int contentType = json.optInt("ContentType");
                String fileId = json.optString("FileID");
                int messageType = json.optInt("MessageType");
                if (messageType == 0) {
                    if (filename != null && !filename.equals("")) {
                        contentType = FileUtils.getContentType(filename);
                    }
                    if (contentType == 0 || contentType == 1 || contentType == 2) {
                        //文字，图片
                        ret = 3;
                    } else if (contentType == 4) {
                        //视频
                        ret = 5;
                    } else if (contentType == 8 || contentType == 9) {
                        //发动态
                        ret = 8;
                    } else {
                        //文件
                        ret = 4;
                    }
                } else if (messageType == 10) {
                    ret = 6;
                }
            } else if (message.getContent() instanceof ImageMessage) {
                ret = 3;
            }
        }
        return ret;
    }

    public View getView(int position, View convertView, ViewGroup parent) {
        Message message = messageList.get(position);
        int type = getItemViewType(position);
        switch (type) {
            //发文字，图片
            case 0:
                convertView = getSendView(convertView, parent, message, position);
                break;
            //发文件
            case 1:
                convertView = getSendFileView(convertView, parent, position, 0);
                break;
            //发视频
            case 2:
                convertView = getSendVideoView(convertView, parent, position);
                break;
            //收文字，图片
            case 3:
                convertView = getFromView(convertView, parent, message, position);
                break;
            //收文件
            case 4:
                convertView = getReceiveFileView(convertView, parent, position, 0);
                break;
            //收视频
            case 5:
                convertView = getReceiveVideoView(convertView, parent, position);
                break;
            case 6:
                //显示系统消息
                convertView = getSystemView(convertView, parent, position);
                break;
            //发动态
            case 7:
                convertView = getSendFileView(convertView, parent, position, 1);
                break;
            //收动态
            case 8:
                convertView = getReceiveFileView(convertView, parent, position, 1);
                break;
            default:
                break;
        }
        return convertView;
    }

    private View getSendView(View convertView, ViewGroup parent, Message message, int position) {
        SendViewHolder sendViewHolder = null;
        if (convertView == null) {
            convertView = LayoutInflater.from(mContext).inflate(R.layout.send_view, null);
            sendViewHolder = new SendViewHolder();
            sendViewHolder.messageTextView = (TextView) convertView.findViewById(R.id.send_message);
            sendViewHolder.icon = (ShapeImageView) convertView.findViewById(R.id.send_icon);
            sendViewHolder.messageImage = (ImageView) convertView.findViewById(R.id.send_Imagemessage);
            sendViewHolder.tv_progress = (TextView) convertView.findViewById(R.id.send_pro_tv);
            sendViewHolder.img_tv = (ImageView) convertView.findViewById(R.id.img_send_tv_fail);
            sendViewHolder.img_pic = (ImageView) convertView.findViewById(R.id.img_send_img_fail);
            sendViewHolder.tv_time = (TextView) convertView.findViewById(R.id.message_time);
            convertView.setTag(sendViewHolder);
        } else {
            sendViewHolder = (SendViewHolder) convertView.getTag();
        }

        sendViewHolder.tv_time.setVisibility(View.GONE);
        setTime(position, sendViewHolder.tv_time);

        if (message.getSenderUserId() != null) {
            String iconUrl = String.format(Constant.STUDY_GET_USER_PIC, message.getSenderUserId());
            Picasso.with(mContext).load(iconUrl).resize((int) mContext.getResources().getDimension(R.dimen.view_43),
                    (int) mContext.getResources().getDimension(R.dimen.view_43)).placeholder(R.mipmap.ic_liaotiantouxiang)
                    .error(R.mipmap.ic_liaotiantouxiang).into(sendViewHolder.icon);
        }
        sendViewHolder.img_tv.setVisibility(View.GONE);
        sendViewHolder.img_pic.setVisibility(View.GONE);

        if (message.getContent() instanceof TextMessage || message.getContent() instanceof SpaceMessage) {
            sendViewHolder.messageImage.setVisibility(View.GONE);
            sendViewHolder.tv_progress.setVisibility(View.GONE);
            sendViewHolder.messageTextView.setVisibility(View.VISIBLE);
            Message.SentStatus sentStatus = message.getSentStatus();
            String info = null;
            if (message.getContent() instanceof TextMessage) {
                TextMessage text = (TextMessage) message.getContent();
                info = text.getContent();
            } else if (message.getContent() instanceof SpaceMessage) {
                SpaceMessage spaceMessage = (SpaceMessage) message.getContent();
                info = spaceMessage.getContent();
            }
            try {
                JSONObject json = new JSONObject(info);
                String content = json.getString("Content");
                String filename = json.optString("FileName");
                int contentType = json.optInt("ContentType");
                String fileId = json.optString("FileID");
                if (filename != null && !filename.equals("")) {
                    contentType = FileUtils.getContentType(filename);
                }
                if (fileId == null) {
                    fileId = "";
                }
                if (contentType == 0 || contentType == 1) {
                    if (sentStatus == Message.SentStatus.FAILED) {
                        sendViewHolder.img_tv.setVisibility(View.VISIBLE);
                    }
                    SpannableString string = SpanStringUtils.getEmotionContent(emotion_map_type, mContext, sendViewHolder.messageTextView, content);
                    sendViewHolder.messageTextView.setText(string);
                } else if (contentType == 2) {
                    if (sentStatus == Message.SentStatus.FAILED) {
                        sendViewHolder.img_pic.setVisibility(View.VISIBLE);
                    }
                    sendViewHolder.messageTextView.setVisibility(View.GONE);
                    sendViewHolder.messageImage.setVisibility(View.VISIBLE);
                    String url = "";
                    if (fileId.contains("http")) {
                        url = fileId;
                    } else {
                        url = String.format(Constant.STUDY_OPEN_FILE, fileId);
                    }
                    Picasso.with(mContext).load(url).placeholder(R.mipmap.img_morentupian).config(Bitmap.Config.RGB_565).into(sendViewHolder.messageImage);
                    sendViewHolder.messageImage.setTag(message);
                    sendViewHolder.messageImage.setOnClickListener(onMesgClick);
                } else {
                    sendViewHolder.messageTextView.setText("[文件]");
                }
//                ChatMessageUtil chat = new ChatMessageUtil();
//                chat.setMessageView(contentType, sendViewHolder.messageTextView, content, mContext);
            } catch (JSONException e) {
                e.printStackTrace();
            }
        } else if (message.getContent() instanceof ImageMessage) {
            sendViewHolder.messageTextView.setVisibility(View.GONE);
            sendViewHolder.messageImage.setVisibility(View.VISIBLE);
            int id = message.getMessageId();
            Message.SentStatus sentStatus = message.getSentStatus();
            if (sentStatus == Message.SentStatus.FAILED) {
                sendViewHolder.img_pic.setVisibility(View.VISIBLE);
            }
            ImageProgress imageProgress = null;
            if (progressList != null) {
                for (int i = 0; i < progressList.size(); i++) {
                    imageProgress = progressList.get(i);
                    if (imageProgress.getMsgId() == id) {
                        break;
                    }
                    imageProgress = null;
                }
                if (imageProgress != null) {
                    sendViewHolder.tv_progress.setVisibility(View.VISIBLE);
                    sendViewHolder.tv_progress.setText(imageProgress.getProgress() + "%");
                    if (imageProgress.getProgress() >= 98) {
                        sendViewHolder.tv_progress.setVisibility(View.GONE);
                    }
                }
            }
            ImageMessage imageMessage = (ImageMessage) message.getContent();
            Uri uri = imageMessage.getThumUri();
            Picasso.with(mContext).load(uri).config(Bitmap.Config.RGB_565).placeholder(R.mipmap.img_morentupian).into(sendViewHolder.messageImage);

            sendViewHolder.messageImage.setTag(message);
            sendViewHolder.messageImage.setOnClickListener(onMesgClick);
        } else {
            Message.SentStatus sentStatus = message.getSentStatus();
            if (sentStatus == Message.SentStatus.FAILED) {
                sendViewHolder.img_tv.setVisibility(View.VISIBLE);
            }
            sendViewHolder.messageTextView.setText("[动态]");
        }
        sendViewHolder.icon.setTag("-1");
        sendViewHolder.icon.setOnClickListener(onHeadClick);

        sendViewHolder.messageTextView.setTag(message);
        sendViewHolder.messageTextView.setOnLongClickListener(onMesgLongClick);

        sendViewHolder.messageImage.setTag(message);
        sendViewHolder.messageImage.setOnLongClickListener(onMesgLongClick);

        sendViewHolder.img_tv.setTag(message);
        sendViewHolder.img_tv.setOnClickListener(onclickSendMessage);

        sendViewHolder.img_pic.setTag(message);
        sendViewHolder.img_pic.setOnClickListener(onclickSendMessage);
        return convertView;
    }

    private View getFromView(View convertView, ViewGroup parent, Message message, int position) {
        FromViewHolder fromViewHolder = null;
        if (convertView == null) {
            convertView = LayoutInflater.from(mContext).inflate(R.layout.receive_view, null);
            fromViewHolder = new FromViewHolder();
            fromViewHolder.nameTextView = (TextView) convertView.findViewById(R.id.receive_name);
            fromViewHolder.messageTextView = (TextView) convertView.findViewById(R.id.receive_message);
            fromViewHolder.icon = (ShapeImageView) convertView.findViewById(R.id.receive_icon);
            fromViewHolder.messageImage = (ImageView) convertView.findViewById(R.id.receive_Imagemessage);
            fromViewHolder.tv_time = (TextView) convertView.findViewById(R.id.message_time);
            convertView.setTag(fromViewHolder);
        } else {
            fromViewHolder = (FromViewHolder) convertView.getTag();
        }

        //设置时间
        setTime(position, fromViewHolder.tv_time);

        String iconUrl = String.format(Constant.STUDY_GET_USER_PIC, message.getTargetId());
        Picasso.with(mContext).load(iconUrl).resize((int) mContext.getResources().getDimension(R.dimen.view_43),
                (int) mContext.getResources().getDimension(R.dimen.view_43)).placeholder(R.mipmap.ic_liaotiantouxiang).error(R.mipmap.ic_liaotiantouxiang).into(fromViewHolder.icon);
        if (message.getContent().getUserInfo() != null) {
            friendName = message.getContent().getUserInfo().getName();
            fromViewHolder.nameTextView.setText(message.getContent().getUserInfo().getName());
        }
        if (message.getContent() instanceof TextMessage || message.getContent() instanceof SpaceMessage) {
            fromViewHolder.messageTextView.setVisibility(View.VISIBLE);
            fromViewHolder.messageImage.setVisibility(View.GONE);
            String info = null;
            if (message.getContent() instanceof TextMessage) {
                TextMessage text = (TextMessage) message.getContent();
                info = text.getContent();
            } else if (message.getContent() instanceof SpaceMessage) {
                SpaceMessage spaceMessage = (SpaceMessage) message.getContent();
                info = spaceMessage.getContent();
            }
            try {
                JSONObject json = new JSONObject(info);
                String content = json.getString("Content");
                String filename = json.optString("FileName");
                int contentType = json.optInt("ContentType");
                String fileId = json.optString("FileID");
                if (filename != null && !filename.equals("")) {
                    contentType = FileUtils.getContentType(filename);
                }
                if (fileId == null) {
                    fileId = "";
                }
                if (contentType == 0 || contentType == 1) {
                    SpannableString string = SpanStringUtils.getEmotionContent(emotion_map_type, mContext, fromViewHolder.messageTextView, content);
                    fromViewHolder.messageTextView.setText(string);
                } else if (contentType == 2) {
                    fromViewHolder.messageTextView.setVisibility(View.GONE);
                    fromViewHolder.messageImage.setVisibility(View.VISIBLE);
                    String url = "";
                    if (url.contains("http")) {
                        url = fileId;
                    } else {
                        url = String.format(Constant.STUDY_OPEN_FILE, fileId);
                    }
                    Picasso.with(mContext).load(url).placeholder(R.mipmap.img_morentupian).config(Bitmap.Config.RGB_565).
                            into(fromViewHolder.messageImage);
                    fromViewHolder.messageImage.setTag(message);
                    fromViewHolder.messageImage.setOnClickListener(onMesgClick);
                } else if (message.getContent() instanceof RecallNotificationMessage) {

                } else {
                    fromViewHolder.messageTextView.setText("[消息]");
                }
//                ChatMessageUtil chat = new ChatMessageUtil();
//                chat.setMessageView(contentType, fromViewHolder.messageTextView, content, mContext, message);
            } catch (JSONException e) {
                e.printStackTrace();
            }

        } else if (message.getContent() instanceof ImageMessage) {
            fromViewHolder.messageTextView.setVisibility(View.GONE);
            fromViewHolder.messageImage.setVisibility(View.VISIBLE);
            ImageMessage imageMessage = (ImageMessage) message.getContent();
            Uri uri = imageMessage.getThumUri();
            Picasso.with(mContext).load(uri).placeholder(R.mipmap.img_morentupian).into(fromViewHolder.messageImage);

            fromViewHolder.messageImage.setTag(message);
            fromViewHolder.messageImage.setOnClickListener(onMesgClick);
        } else {
            fromViewHolder.messageTextView.setText("[动态]");
        }

        if (!isShowName) {
            fromViewHolder.nameTextView.setVisibility(View.VISIBLE);
        } else {
            fromViewHolder.nameTextView.setVisibility(View.GONE);
        }
        fromViewHolder.icon.setTag(message.getTargetId());
        fromViewHolder.icon.setOnClickListener(onHeadClick);

        fromViewHolder.messageTextView.setTag(message);
        fromViewHolder.messageTextView.setOnLongClickListener(onMesgLongClick);
        fromViewHolder.messageImage.setOnLongClickListener(onMesgLongClick);
        return convertView;
    }

    private void setTime(int position, TextView tv) {
        tv.setVisibility(View.GONE);
        try {
            long time = 0;
            if (position == 0) {
                Message msg = messageList.get(0);
                RMessage rMessage = new RMessage(msg);
                time = rMessage.getCreateTime();
                if (time > 0) {
                    tv.setVisibility(View.VISIBLE);
                    tv.setText(FileUtils.getMessageTime(time + ""));
                }
            } else if (position < messageList.size()) {
                Message message1 = messageList.get(position - 1);
                Message message2 = messageList.get(position);
                RMessage rMessage1 = new RMessage(message1);
                RMessage rMessage2 = new RMessage(message2);
                long t1 = 0, t2 = 0;
                t1 = rMessage1.getCreateTime();
                t2 = rMessage2.getCreateTime();
                if (t2 - t1 >= 5 * 1000 * 60) {
                    tv.setVisibility(View.VISIBLE);
                    tv.setText(FileUtils.getMessageTime(t2 + ""));
                }
            }
        } catch (Exception e) {
            tv.setVisibility(View.GONE);
        }
    }

    //发送文件 type=0 文件 type 1 动态
    private View getSendFileView(View convertView, ViewGroup parent, int position, int type) {
        SendViewHolder holder = null;
        if (convertView == null) {
            convertView = LayoutInflater.from(mContext).inflate(R.layout.message_send_file, null);
            holder = new SendViewHolder();
            holder.icon = (ImageView) convertView.findViewById(R.id.send_icon);
            holder.messageImage = (ImageView) convertView.findViewById(R.id.send_pic_message);
            holder.messageTextView = (TextView) convertView.findViewById(R.id.send_tv_message);
            holder.linearLayout = (LinearLayout) convertView.findViewById(R.id.send_file_message);
            holder.tv_content = (TextView) convertView.findViewById(R.id.send_tv_content);
            holder.tv_time = (TextView) convertView.findViewById(R.id.message_time);
            convertView.setTag(holder);
        } else {
            holder = (SendViewHolder) convertView.getTag();
        }

        setTime(position, holder.tv_time);

        Message message = messageList.get(position);
        if (message.getSenderUserId() != null) {
            String iconUrl = String.format(Constant.STUDY_GET_USER_PIC, message.getSenderUserId());
            Picasso.with(mContext).load(iconUrl).resize((int) mContext.getResources().getDimension(R.dimen.view_43),
                    (int) mContext.getResources().getDimension(R.dimen.view_43)).placeholder(R.mipmap.ic_liaotiantouxiang).error(R.mipmap.ic_liaotiantouxiang).into(holder.icon);
        }
        if (message.getContent() instanceof TextMessage || message.getContent() instanceof SpaceMessage) {
            String info = null;
            if (message.getContent() instanceof TextMessage) {
                TextMessage textMessage = (TextMessage) message.getContent();
                info = textMessage.getContent();
            } else if (message.getContent() instanceof SpaceMessage) {
                SpaceMessage spaceMessage = (SpaceMessage) message.getContent();
                info = spaceMessage.getContent();
            }
            try {
                JSONObject json = new JSONObject(info);
                String filename = json.optString("FileName");
                String fileId = json.optString("FileID");
                String name = json.optString("requestName");
                if (type == 0) {
                    String url = String.format(Constant.STUDY_OPEN_FILE, fileId);
                    FileUtils.setImage(holder.messageImage, filename, url, mContext);
                    filename = FileUtils.getFileName(filename);
                    holder.messageTextView.setText(filename);
                    holder.tv_content.setVisibility(View.GONE);
                } else if (type == 1) {
                    holder.messageImage.setImageResource(R.mipmap.img_lianjie_liaotianchuang);
                    holder.messageTextView.setText(name);
                    String bulletinContent = json.optString("BulletinContent");
                    JSONObject jsonObject = null;
                    String content = "";
                    if (bulletinContent != null && !bulletinContent.equals("")) {
                        jsonObject = new JSONObject(bulletinContent);
                        content = jsonObject.optString("content");
                    }
                    if (content != null) {
                        holder.tv_content.setText(content);
                        holder.tv_content.setVisibility(View.VISIBLE);
                    }
                    //holder.linearLayout.setBackgroundResource(R.mipmap.img_qipao_lianjie);
                }
            } catch (JSONException e) {
                e.printStackTrace();
            }
            holder.linearLayout.setTag(message);
            holder.linearLayout.setOnClickListener(onclickOpenFile);
            holder.linearLayout.setOnLongClickListener(onMesgLongClick);

            holder.icon.setTag("-1");
            holder.icon.setOnClickListener(onHeadClick);
        }
        return convertView;
    }

    //接收文件 type = 0 文件 type 1 动态
    private View getReceiveFileView(View convertView, ViewGroup parent, int position, int type) {
        FromViewHolder holder = null;
        if (convertView == null) {
            convertView = LayoutInflater.from(mContext).inflate(R.layout.message_receive_file, null);
            holder = new FromViewHolder();
            holder.icon = (ImageView) convertView.findViewById(R.id.receive_icon);
            holder.nameTextView = (TextView) convertView.findViewById(R.id.receive_name);
            holder.messageImage = (ImageView) convertView.findViewById(R.id.receive_pic_message);
            holder.messageTextView = (TextView) convertView.findViewById(R.id.receiver_tv_message);
            holder.tv_content = (TextView) convertView.findViewById(R.id.receive_tv_content);
            holder.linearLayot = (LinearLayout) convertView.findViewById(R.id.receive_file_message);
            holder.tv_time = (TextView) convertView.findViewById(R.id.message_time);
            convertView.setTag(holder);
        } else {
            holder = (FromViewHolder) convertView.getTag();
        }
        setTime(position, holder.tv_time);

        Message message = messageList.get(position);
        String iconUrl = String.format(Constant.STUDY_GET_USER_PIC, message.getTargetId());
        Picasso.with(mContext).load(iconUrl).resize((int) mContext.getResources().getDimension(R.dimen.view_43),
                (int) mContext.getResources().getDimension(R.dimen.view_43)).placeholder(R.mipmap.ic_liaotiantouxiang).error(R.mipmap.ic_liaotiantouxiang).into(holder.icon);
        if (message.getContent().getUserInfo() != null) {
            friendName = message.getContent().getUserInfo().getName();
            holder.nameTextView.setText(message.getContent().getUserInfo().getName());
        }
        if (message.getContent() instanceof TextMessage || message.getContent() instanceof SpaceMessage) {
            String info = null;
            if (message.getContent() instanceof TextMessage) {
                TextMessage textMessage = (TextMessage) message.getContent();
                info = textMessage.getContent();
            } else if (message.getContent() instanceof SpaceMessage) {
                SpaceMessage spaceMessage = (SpaceMessage) message.getContent();
                info = spaceMessage.getContent();
            }
            try {
                JSONObject json = new JSONObject(info);
                String filename = json.optString("FileName");
                String fileId = json.optString("FileID");
                String name = json.optString("requestName");
                if (type == 0) {
                    String url = String.format(Constant.STUDY_OPEN_FILE, fileId);
                    FileUtils.setImage(holder.messageImage, filename, url, mContext);
                    filename = FileUtils.getFileName(filename);
                    holder.messageTextView.setText(filename);
                    holder.tv_content.setVisibility(View.GONE);
                } else if (type == 1) {
                    holder.messageImage.setImageResource(R.mipmap.img_lianjie_liaotianchuang);
                    holder.messageTextView.setText(name);
                    String bulletinContent = json.optString("BulletinContent");
//                    Log.i("bull", "bull=" + bulletinContent);
                    JSONObject object = null;
                    String content = "";
                    if (bulletinContent != null) {
                        object = new JSONObject(bulletinContent);
                        content = object.optString("content");
                    }
                    if (content != null) {
                        holder.tv_content.setText(content);
                        holder.tv_content.setVisibility(View.VISIBLE);
                    }
                }
            } catch (JSONException e) {
                e.printStackTrace();
            }
            holder.linearLayot.setTag(message);
            holder.linearLayot.setOnClickListener(onclickOpenFile);
            holder.linearLayot.setOnLongClickListener(onMesgLongClick);

            holder.icon.setTag(message.getTargetId());
            holder.icon.setOnClickListener(onHeadClick);
        }
        return convertView;
    }

    //发送视频文件
    private View getSendVideoView(View convertView, ViewGroup parent, int position) {
        SendViewHolder holder = null;
        if (convertView == null) {
            convertView = LayoutInflater.from(mContext).inflate(R.layout.message_send_video, null);
            holder = new SendViewHolder();
            holder.icon = (ImageView) convertView.findViewById(R.id.send_icon);
            holder.messageImage = (ImageView) convertView.findViewById(R.id.send_message_pic);
            holder.img_tv = (ImageView) convertView.findViewById(R.id.img_send_tv_fail);
            holder.messageTextView = (TextView) convertView.findViewById(R.id.send_video_name);
            holder.frameLayout = (FrameLayout) convertView.findViewById(R.id.send_message_frame);
            holder.tv_time = (TextView) convertView.findViewById(R.id.message_time);
            convertView.setTag(holder);
        } else {
            holder = (SendViewHolder) convertView.getTag();
        }
        setTime(position, holder.tv_time);

        Message message = messageList.get(position);
        if (message.getSenderUserId() != null) {
            String iconUrl = String.format(Constant.STUDY_GET_USER_PIC, message.getSenderUserId());
            Picasso.with(mContext).load(iconUrl).resize((int) mContext.getResources().getDimension(R.dimen.view_43),
                    (int) mContext.getResources().getDimension(R.dimen.view_43)).placeholder(R.mipmap.ic_liaotiantouxiang).error(R.mipmap.ic_liaotiantouxiang).into(holder.icon);
        }
        if (message.getContent() instanceof TextMessage || message.getContent() instanceof SpaceMessage) {
            String info = null;
            if (message.getContent() instanceof TextMessage) {
                TextMessage textMessage = (TextMessage) message.getContent();
                info = textMessage.getContent();
            } else if (message.getContent() instanceof SpaceMessage) {
                SpaceMessage spaceMessage = (SpaceMessage) message.getContent();
                info = spaceMessage.getContent();
            }
            try {
                JSONObject json = new JSONObject(info);
                String filename = json.optString("FileName");
                String fileId = json.optString("FileID");
                holder.messageTextView.setText(FileUtils.getFileName(filename));
                String url = String.format(Constant.MESSAGE_GET_FILE_DETIAL, fileId);
                holder.messageImage.setTag(url);
                setVideoScale(url, holder.messageImage);

                holder.frameLayout.setTag(message);
                holder.frameLayout.setOnClickListener(onclickOpenFile);
                holder.frameLayout.setOnLongClickListener(onMesgLongClick);

                holder.icon.setTag("-1");
                holder.icon.setOnClickListener(onHeadClick);
            } catch (JSONException e) {
                e.printStackTrace();
            }
        }
        return convertView;
    }

    //接收视频文件
    private View getReceiveVideoView(View convertView, ViewGroup parent, int position) {
        FromViewHolder holder = null;
        if (convertView == null) {
            convertView = LayoutInflater.from(mContext).inflate(R.layout.message_receive_video, null);
            holder = new FromViewHolder();
            holder.icon = (ImageView) convertView.findViewById(R.id.receive_icon);
            holder.messageImage = (ImageView) convertView.findViewById(R.id.receive_message_pic);
            holder.nameTextView = (TextView) convertView.findViewById(R.id.receive_name);
            holder.messageTextView = (TextView) convertView.findViewById(R.id.receive_video_name);
            holder.frameLayout = (FrameLayout) convertView.findViewById(R.id.receive_message_frame);
            holder.tv_time = (TextView) convertView.findViewById(R.id.message_time);
            convertView.setTag(holder);
        } else {
            holder = (FromViewHolder) convertView.getTag();
        }
        setTime(position, holder.tv_time);

        Message message = messageList.get(position);
        String iconUrl = String.format(Constant.STUDY_GET_USER_PIC, message.getTargetId());
        Picasso.with(mContext).load(iconUrl).resize((int) mContext.getResources().getDimension(R.dimen.view_43),
                (int) mContext.getResources().getDimension(R.dimen.view_43)).placeholder(R.mipmap.ic_liaotiantouxiang).error(R.mipmap.ic_liaotiantouxiang).into(holder.icon);
        if (message.getContent().getUserInfo() != null) {
            friendName = message.getContent().getUserInfo().getName();
            holder.nameTextView.setText(message.getContent().getUserInfo().getName());
        }
        if (message.getContent() instanceof TextMessage || message.getContent() instanceof SpaceMessage) {
            String info = null;
            if (message.getContent() instanceof TextMessage) {
                TextMessage textMessage = (TextMessage) message.getContent();
                info = textMessage.getContent();
            } else if (message.getContent() instanceof SpaceMessage) {
                SpaceMessage spaceMessage = (SpaceMessage) message.getContent();
                info = spaceMessage.getContent();
            }
            try {
                JSONObject json = new JSONObject(info);
                String filename = json.optString("FileName");
                String fileId = json.optString("FileID");
                holder.messageTextView.setText(FileUtils.getFileName(filename));
                String url = String.format(Constant.MESSAGE_GET_FILE_DETIAL, fileId);
                holder.messageImage.setTag(url);
                setVideoScale(url, holder.messageImage);

                holder.frameLayout.setTag(message);
                holder.frameLayout.setOnClickListener(onclickOpenFile);
                holder.frameLayout.setOnLongClickListener(onMesgLongClick);

                holder.icon.setTag(message.getTargetId());
                holder.icon.setOnClickListener(onHeadClick);
            } catch (JSONException e) {
                e.printStackTrace();
            }
        }
        return convertView;
    }

    //设置视频缩略图
    private void setVideoScale(final String url, final ImageView img) {
        new Thread(new Runnable() {
            @Override
            public void run() {
                final String result = httpManager.getFileInfo(url);
                mHandler.post(new Runnable() {
                    @Override
                    public void run() {
                        String tag = (String) img.getTag();
                        if (tag.equals(url)) {
                            if (result != null && !result.equals("") && !result.equals("404")) {
                                String path = "";
                                try {
                                    JSONObject json = new JSONObject(result);
                                    path = json.getString("scale");
                                    if (!path.contains("base64")) {
                                        path = Constant.ADDRESS_STUDY + path;
                                        Picasso.with(mContext).load(path).placeholder(R.mipmap.img_morentupian).config(Bitmap.Config.RGB_565).into(img);
                                    } else {
                                        path = path.substring(path.indexOf("base64") + 7);
                                        Bitmap bm = BitmapUtils.stringtoBitmap(path);
                                        img.setImageBitmap(bm);
                                    }
                                } catch (JSONException e) {
                                    e.printStackTrace();
                                }
                            } else {
                                img.setImageResource(R.mipmap.img_morentupian);
                            }
                        }
                    }
                });
            }
        }).start();
    }

    //设置系统消息
    private View getSystemView(View convertView, ViewGroup parent, int position) {
        SendViewHolder holder = null;
        if (convertView == null) {
            convertView = LayoutInflater.from(mContext).inflate(R.layout.message_time, null);
            holder = new SendViewHolder();
            holder.messageTextView = (TextView) convertView.findViewById(R.id.message_time);
            convertView.setTag(holder);
        } else {
            holder = (SendViewHolder) convertView.getTag();
        }
        Message message = messageList.get(position);
        if (message.getContent() instanceof TextMessage) {
            TextMessage textMessage = (TextMessage) message.getContent();
            String info = textMessage.getContent();
            try {
                JSONObject json = new JSONObject(info);
                int messageType = json.getInt("MessageType");
                String requestName = json.getString("requestName");
                if (messageType == 10) {
                    if (requestName != null) {
                        holder.messageTextView.setVisibility(View.VISIBLE);
                        if (message.getMessageDirection() == Message.MessageDirection.SEND) {
                            holder.messageTextView.setText("你撤回了一条消息");
                        } else if (message.getMessageDirection() == Message.MessageDirection.RECEIVE) {
                            holder.messageTextView.setText(requestName + "撤回了一条消息");
                        }
                    }
                }
            } catch (JSONException e) {
                e.printStackTrace();
            }
        }
        return convertView;
    }

    private class FromViewHolder {
        public TextView nameTextView;
        public TextView messageTextView;
        public ImageView messageImage, icon;
        LinearLayout linearLayot;
        FrameLayout frameLayout;
        TextView tv_content, tv_time;
    }

    private class SendViewHolder {
        public TextView messageTextView;
        public ImageView messageImage, icon;
        TextView tv_progress;
        ImageView img_tv, img_pic;
        LinearLayout linearLayout;
        FrameLayout frameLayout;
        TextView tv_content, tv_time;
    }

}
