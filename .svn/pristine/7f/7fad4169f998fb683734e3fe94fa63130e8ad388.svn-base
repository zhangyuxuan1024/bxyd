package net.iclassmate.xydspace.ui.activity.constacts;

import android.content.BroadcastReceiver;
import android.content.Context;
import android.content.Intent;
import android.content.IntentFilter;
import android.content.SharedPreferences;
import android.graphics.Color;
import android.graphics.drawable.AnimationDrawable;
import android.os.Bundle;
import android.os.Handler;
import android.os.Message;
import android.support.v4.app.FragmentActivity;
import android.view.LayoutInflater;
import android.view.View;
import android.widget.AdapterView;
import android.widget.ImageView;
import android.widget.ListView;
import android.widget.RelativeLayout;
import android.widget.TextView;
import android.widget.Toast;

import net.iclassmate.xydspace.R;
import net.iclassmate.xydspace.adapter.GroupListAdapter;
import net.iclassmate.xydspace.bean.contacts.Group;
import net.iclassmate.xydspace.bean.contacts.GroupInfo;
import net.iclassmate.xydspace.constant.Constant;
import net.iclassmate.xydspace.ui.activity.information.FriendInformationActivity;
import net.iclassmate.xydspace.utils.HttpManager;
import net.iclassmate.xydspace.utils.JsonUtils;
import net.iclassmate.xydspace.utils.UIUtils;
import net.iclassmate.xydspace.view.Loading;
import net.iclassmate.xydspace.view.TitleBar;

public class GroupListActivity extends FragmentActivity implements TitleBar.TitleOnClickListener {
    private Context mContext;
    private TitleBar titleBar;
    private ListView groupLv;
    private String userId;
    private String result;
    private Group group;
    private GroupInfo groupInfo;
    private TextView count;
    private GroupListAdapter groupListAdapter;
    private HttpManager httpManager;
    private SharedPreferences sp;
    private int positionList;
    public static final int REQUEST_SUCCESS = 0;
    public static final int REQUEST_FAIL = 1;

    private AnimationDrawable anim;
    private ImageView img_anim;
    Handler mHandler = new Handler() {
        @Override
        public void handleMessage(Message msg) {
            super.handleMessage(msg);
            anim.stop();
            img_anim.setVisibility(View.GONE);
            switch (msg.what) {
                case REQUEST_SUCCESS:
                    group = JsonUtils.jsonGroupInfo(result);
                    int size = group.getList().size();
                    count.setText(size + "个群组");
                    if (groupListAdapter == null) {
                        groupListAdapter = new GroupListAdapter(mContext, group);
                        groupLv.setAdapter(groupListAdapter);
                    } else {
                        groupListAdapter.notifyDataSetChanged();
                    }
                    break;
                case REQUEST_FAIL:
                    img_anim.setVisibility(View.VISIBLE);
                    img_anim.setBackgroundColor(Color.parseColor("#f5f5f5"));
                    img_anim.setImageResource(R.mipmap.img_jiazaishibai);
                    break;
            }
        }
    };

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_group_list);
        mContext = this;
        initView();
        initListener();
        initData();
        initGroupListener();

        //注册广播
        IntentFilter filter = new IntentFilter(SendFriendRequestActivity.action);
        registerReceiver(broadcastreceiver, filter);
    }

    private void initView() {
        titleBar = (TitleBar) findViewById(R.id.groupList_title_bar);
        titleBar.setTitle("群组");
        titleBar.setLeftIcon(R.mipmap.ic_fanhui, "返回");
        groupLv = (ListView) findViewById(R.id.group_lv);
        httpManager = new HttpManager();
        sp = mContext.getSharedPreferences(Constant.SHARED_PREFERENCES, Context.MODE_PRIVATE);
        RelativeLayout footViewLayout = (RelativeLayout) LayoutInflater.from(
                GroupListActivity.this).inflate(R.layout.footer_textview, null);
        count = (TextView) footViewLayout.findViewById(R.id.groups_count);
        groupLv.addFooterView(footViewLayout);

        img_anim = (ImageView) findViewById(R.id.img_anim);
        anim = (AnimationDrawable) img_anim.getBackground();
        anim.start();
    }

    private void initListener() {
        titleBar.setTitleClickListener(this);
    }

    private void initData() {
        userId = sp.getString(Constant.ID_USER, "");
        new Thread(new Runnable() {
            @Override
            public void run() {
                try {
                    result = httpManager.findAllGroup(userId);
                    if (result != null && !result.equals("404")) {
                        mHandler.sendEmptyMessage(REQUEST_SUCCESS);
                    } else {
                        mHandler.sendEmptyMessage(REQUEST_FAIL);
                    }
                } catch (Exception e) {

                }
            }
        }).start();
    }

    private void initGroupListener() {
        groupLv.setOnItemClickListener(new AdapterView.OnItemClickListener() {
            @Override
            public void onItemClick(AdapterView<?> parent, View view, int position, long id) {
                positionList = position;
                groupInfo = group.getList().get(position);
                Intent intent = new Intent(UIUtils.getContext(), FriendInformationActivity.class);
                intent.putExtra("from", "GroupListActivity");
                intent.putExtra("type", "group");
                intent.putExtra("sessionId", groupInfo.getSessionId());
                intent.putExtra("sessionName", groupInfo.getSessionName());
                intent.putExtra("author", groupInfo.getAuthor());
                intent.putExtra("sessionIcon", groupInfo.getSessionIcon());
//                intent.putParcelableArrayListExtra("groupList",group.getList());
//                startActivity(intent);
                startActivityForResult(intent, 10);
            }
        });
    }

    @Override
    protected void onActivityResult(int requestCode, int resultCode, Intent data) {
        if (resultCode == 10) {
            group.getList().remove(positionList);
            groupListAdapter.notifyDataSetChanged();
            count.setText(group.getList().size() + "个群组");
        }
    }

    public BroadcastReceiver broadcastreceiver = new BroadcastReceiver() {
        @Override
        public void onReceive(Context context, Intent intent) {
            String groupName = intent.getStringExtra("updateName");
            group.getList().get(positionList).setSessionName(groupName);
            groupListAdapter.notifyDataSetChanged();
        }
    };

    @Override
    protected void onDestroy() {
        super.onDestroy();
        unregisterReceiver(broadcastreceiver);  //移除广播接收
    }

    @Override
    public void leftClick() {
        finish();

    }

    @Override
    public void rightClick() {

    }

    @Override
    public void titleClick() {

    }

    @Override
    public void innerleftClick() {

    }

    @Override
    public void innerRightClick() {

    }
}
